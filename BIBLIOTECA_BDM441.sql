CREATE DATABASE BIBLIOTECA_DB

USE BIBLIOTECA_DB

CREATE TABLE PAIS(
	cod_pais CHAR(3) PRIMARY KEY NOT NULL,
	nombre VARCHAR(50),
	capital VARCHAR(50),
	acronimo CHAR(3)
)

CREATE TABLE AUTOR(
	cod_autor CHAR(3) PRIMARY KEY NOT NULL,
	nombre VARCHAR(50),
	apellido VARCHAR(50),
	fecha_nacimiento DATE,
	cod_pais CHAR(3)
)

CREATE TABLE CATEGORIA(
	cod_cat CHAR(3) PRIMARY KEY NOT NULL,
	nombre VARCHAR(50),
	acronimo CHAR(3)
)

CREATE TABLE EDITORIAL(
	cod_editorial CHAR(3) PRIMARY KEY NOT NULL,
	nombre VARCHAR(50),
	acronimo CHAR(3),
	cod_pais CHAR(3)
)

CREATE TABLE IDIOMA(
	cod_idioma CHAR(3) PRIMARY KEY NOT NULL,
	nombre VARCHAR(20),
	acronimo CHAR(3)
)

CREATE TABLE LIBROS(
	isbn BIGINT PRIMARY KEY NOT NULL,
	titulo VARCHAR(100),
	copias_disponibles TINYINT,
	autor CHAR(3),
	categoria CHAR(3),
	editorial CHAR(3),
	idioma CHAR(3)
)

CREATE TABLE LECTORES(
	id_lector CHAR(5) PRIMARY KEY NOT NULL,
	nombre VARCHAR(50),
	apellido VARCHAR(50),
	fecha_nacimiento DATE,
	edad AS DATEDIFF(YEAR, fecha_nacimiento, GETDATE())
)

CREATE TABLE PRESTAMO(
	isbn BIGINT,
	id_lector CHAR(5),
	fecha_prestamo DATE,
	fecha_devolucion AS DATEADD(DAY,7,fecha_prestamo) PERSISTED,
	estado AS CASE 
			WHEN (DAY(GETDATE()) - DAY(DATEADD(DAY,7,fecha_prestamo))) <= 7 THEN 'ACTIVO'
			WHEN (DAY(GETDATE()) - DAY(DATEADD(DAY,7,fecha_prestamo))) > 7 THEN 'FINALIZADO'
	END
	CONSTRAINT pk_prestamos PRIMARY KEY (isbn,id_lector)
)

ALTER TABLE AUTOR ADD CONSTRAINT FK_AUTOR_PAIS FOREIGN KEY (cod_pais) REFERENCES PAIS(cod_pais)
	ON UPDATE CASCADE
	ON DELETE CASCADE

ALTER TABLE EDITORIAL ADD CONSTRAINT FK_EDITORIAL_PAIS FOREIGN KEY (cod_pais) REFERENCES PAIS(cod_pais)
	ON UPDATE CASCADE
	ON DELETE CASCADE

ALTER TABLE LIBROS ADD CONSTRAINT FK_LIBROS_AUTOR FOREIGN KEY (autor) REFERENCES AUTOR(cod_autor)
	ON UPDATE CASCADE
	ON DELETE CASCADE
ALTER TABLE LIBROS ADD CONSTRAINT FK_LIBROS_CATEGORIA FOREIGN KEY (categoria) REFERENCES CATEGORIA(cod_cat)
	ON UPDATE CASCADE
	ON DELETE CASCADE
ALTER TABLE LIBROS ADD CONSTRAINT FK_LIBROS_EDITORIAL FOREIGN KEY (editorial) REFERENCES EDITORIAL(cod_editorial)
ALTER TABLE LIBROS ADD CONSTRAINT FK_LIBROS_IDIOMA FOREIGN KEY (idioma) REFERENCES IDIOMA(cod_idioma)
	ON UPDATE CASCADE
	ON DELETE CASCADE

ALTER TABLE PRESTAMO ADD CONSTRAINT FK_PRESTAMOS_LIBROS FOREIGN KEY (isbn) REFERENCES LIBROS(isbn)
	ON UPDATE CASCADE
	ON DELETE CASCADE
ALTER TABLE PRESTAMO ADD CONSTRAINT FK_PRESTAMOS_LECTOR FOREIGN KEY (id_lector) REFERENCES LECTORES(id_lector)
	ON UPDATE CASCADE
	ON DELETE CASCADE


-- IDIOMA( cod_idioma, nombre, acronimo )
INSERT IDIOMA VALUES ('I01', 'Español', 'es')
INSERT IDIOMA VALUES ('I02', 'Ingles', 'en')
INSERT IDIOMA VALUES ('I03', 'Frances', 'fr')
INSERT IDIOMA VALUES ('I04', 'Portugues', 'pt')
INSERT IDIOMA VALUES ('I05', 'Aleman', 'de')

-- CATEGORIA ( cod_cat, nombre, acronimo)
INSERT CATEGORIA VALUES ('C01', 'Ciencia', 'CNC')
INSERT CATEGORIA VALUES ('C02', 'Literatura', 'LIT')
INSERT CATEGORIA VALUES ('C03', 'De Viaje', 'VIJ')
INSERT CATEGORIA VALUES ('C04', 'Biografia', 'BIO')
INSERT CATEGORIA VALUES ('C05', 'Libro de Texto', 'TEX')
INSERT CATEGORIA VALUES ('C06', 'Infantil', 'INF')
INSERT CATEGORIA VALUES ('C07', 'De Referencia', 'REF')
INSERT CATEGORIA VALUES ('C08', 'Monografia', 'MON')
INSERT CATEGORIA VALUES ('C09', 'Recreativo', 'REC')
INSERT CATEGORIA VALUES ('C10', 'Poetico', 'POE')
INSERT CATEGORIA VALUES ('C11', 'Filosofico', 'FIL')
INSERT CATEGORIA VALUES ('C12', 'Ludico', 'LUD')
INSERT CATEGORIA VALUES ('C13', 'Juvenil', 'JUV')
INSERT CATEGORIA VALUES ('C14', 'Comic', 'COM')
INSERT CATEGORIA VALUES ('C15', 'Ficcion', 'FIC')

-- LECTORES ( id_lector, nombre, apellido, fecha_nacimiento )
INSERT LECTORES VALUES ('L0001', 'Francisco', 'Rios', '1998-04-23')
INSERT LECTORES VALUES ('L0002', 'Pablo', 'Escobar', '1980-10-31')
INSERT LECTORES VALUES ('L0003', 'Ramiro', 'Ramirez', '1983-11-12')
INSERT LECTORES VALUES ('L0004', 'Rebeca', 'Gomez', '2000-01-23')
INSERT LECTORES VALUES ('L0005', 'Karla', 'Chavez', '2004-12-31')
INSERT LECTORES VALUES ('L0006', 'Veronica', 'Paz', '1999-01-01')

-- PAIS ( cod_pais, nombre, capital, acronimo )
INSERT PAIS VALUES ('P01', 'El Salvador', 'San Salvador', 'SLV')
INSERT PAIS VALUES ('P02', 'Estados Unidos', 'Washington', 'USA')
INSERT PAIS VALUES ('P03', 'Francia', 'Paris', 'FRA')
INSERT PAIS VALUES ('P04', 'Reino Unido', 'Londres', 'GBR')
INSERT PAIS VALUES ('P05', 'Alemania', 'Berlin', 'DEU')

-- EDITORIAL ( cod_editorial, nombre, acronimo, cod_pais )
INSERT EDITORIAL VALUES ('E01', 'Hermanos Unidos', 'HER', 'P01')
INSERT EDITORIAL VALUES ('E02', 'Larousse', 'LAR', 'P03')
INSERT EDITORIAL VALUES ('E03', 'Conde Nast', 'CON', 'P03')
INSERT EDITORIAL VALUES ('E04', 'Aness Books', 'ANE', 'P04')
INSERT EDITORIAL VALUES ('E05', 'Hurst Books', 'HUR', 'P04')
INSERT EDITORIAL VALUES ('E06', 'Persephone', 'PER', 'P04')
INSERT EDITORIAL VALUES ('E07', 'Scholastic, Inc.', 'SCH', 'P02')
INSERT EDITORIAL VALUES ('E08', 'HarperCollins', 'HAR', 'P02')
INSERT EDITORIAL VALUES ('E09', 'Macmillan', 'MAC', 'P02')
INSERT EDITORIAL VALUES ('E10', 'Sterling', 'STR', 'P02')
INSERT EDITORIAL VALUES ('E11', 'Aufbau-Verlag', 'AUF', 'P05')

-- AUTOR ( cod_autor, nombre, apellido, fecha_nacimiento, cod_pais )
INSERT AUTOR VALUES ('001', 'Alfredo', 'Espino', '1900-01-08', 'P01')
INSERT AUTOR VALUES ('002', 'Albert', 'Camus', '1913-11-07', 'P03')
INSERT AUTOR VALUES ('003', 'Edgar', 'Poe', '1809-01-19', 'P02')
INSERT AUTOR VALUES ('004', 'Mark', 'Twain', '1835-11-30', 'P02')
INSERT AUTOR VALUES ('005', 'John', 'Tolkien', '1892-01-03', 'P04')
INSERT AUTOR VALUES ('006', 'Frances', 'Hodgson', '1849-11-24', 'P04')
INSERT AUTOR VALUES ('007', 'Friederich', 'Nietzsche', '1844-10-15', 'P05')

-- LIBROS ( isbn, titulo, copias_disponibles, autor, categoria, editorial, idioma )
INSERT LIBROS VALUES (9789992366028, 'Jicaras Tristes', 10, '001', 'C10', 'E01', 'I01')
INSERT LIBROS VALUES (9782070360024, 'L''Etranger', 5, '002', 'C02', 'E03', 'I03')
INSERT LIBROS VALUES (9780547928210, 'The Lord of The Rings: The fellowship of the Ring', 20, '005', 'C15', 'E06', 'I02')
INSERT LIBROS VALUES (9780547928203, 'The Lord of The Rings: The Two Towers', 10, '005', 'C15', 'E06', 'I02')
INSERT LIBROS VALUES (9780547928197, 'The Lord of The Rings: The Return of the king', 10, '005', 'C15', 'E06', 'I02')
INSERT LIBROS VALUES (9781840220728, 'Tales of Mystery & Imagination', 5, '003', 'C15', 'E08', 'I02')
INSERT LIBROS VALUES (9781953649805, 'Las Aventuras de Huckleberry Finn', 6, '004', 'C12', 'E10', 'I01')
INSERT LIBROS VALUES (9780064401883, 'El Jardin Secreto', 10, '006', 'C06', 'E04', 'I01')
INSERT LIBROS VALUES (9788026889755, 'Also Sprach Zarathustra : Ein Buch Fur Alle Und Keinen', 5, '007', 'C11', 'E11', 'I05')

-- PRESTAMO ( isbn, id_lector, fecha_prestamo )
INSERT PRESTAMO VALUES (9782070360024, 'L0005', '2023-02-15')
INSERT PRESTAMO VALUES (9781953649805, 'L0001', '2023-02-01')
INSERT PRESTAMO VALUES (9780547928203, 'L0006', '2023-01-30')
INSERT PRESTAMO VALUES (9782070360024, 'L0003', '2023-01-02')
INSERT PRESTAMO VALUES (9780547928197, 'L0002', '2023-02-20')
INSERT PRESTAMO VALUES (9780547928203, 'L0004', '2023-02-21')
INSERT PRESTAMO VALUES (9788026889755, 'L0002', '2023-02-19')
INSERT PRESTAMO VALUES (9780064401883, 'L0003', '2023-01-20')
INSERT PRESTAMO VALUES (9781840220728, 'L0001', '2023-01-31')
INSERT PRESTAMO VALUES (9780547928210, 'L0006', '2023-02-14')

--- CONSULTAS A CAMPOS CALCULADOS ---

SELECT * FROM PRESTAMO

SELECT * FROM LECTORES

-- CONOCER LA CANTIDAD DISPONIBLE DE LIBROS EN STOCK

SELECT T1.isbn, (T1.copias_disponibles - T2.Prestados) AS [Copias Disponibles] FROM LIBROS AS T1 INNER JOIN
(SELECT isbn, COUNT(isbn) AS Prestados FROM PRESTAMO GROUP BY isbn) AS T2 ON T1.isbn = T2.isbn

-- SABER EL LIBRO CON MAS COPIAS DISPONIBLES

SELECT T1.titulo AS TITULO, T2.copias_disponibles AS [COPIAS DISPONIBLES] FROM LIBROS AS T1 INNER JOIN
(SELECT TOP 1 isbn, copias_disponibles FROM LIBROS ORDER BY copias_disponibles DESC) AS T2 ON T1.isbn = T2.isbn

-- SELECCIONAR LA CANTIDAD DE LIBROS QUE TIENE CADA AUTOR

SELECT TABLE1.Autor, SUM(TABLE1.[Cantidad Disponible]) AS [Libros del Autor] FROM (SELECT CONCAT(T1.nombre, ' ', T1.apellido) AS Autor, T2.copias_disponibles AS [Cantidad Disponible] FROM AUTOR AS T1 INNER JOIN
(SELECT autor, copias_disponibles FROM LIBROS) AS T2 ON T1.cod_autor = T2.autor) AS TABLE1 GROUP BY TABLE1.Autor